{% extends 'base.html' %}
{% load static %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h2>
            
            <!-- –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
            {% if restock_requests %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç –ø–æ–≤–∞—Ä–æ–≤</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ö—Ç–æ –∑–∞–ø—Ä–æ—Å–∏–ª</th>
                                    <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in restock_requests %}
                                <tr>
                                    <td>{{ request.created_at|date:"d.m.Y H:i" }}</td>
                                    <td>
                                        <strong>{{ request.ingredient.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">+{{ request.quantity_change }} {{ request.ingredient.unit }}</span>
                                    </td>
                                    <td>{{ request.performed_by.get_full_name|default:request.performed_by.username }}</td>
                                    <td>
                                        <small class="text-muted">{{ request.notes|truncatechars:50 }}</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success" 
                                                data-bs-toggle="modal" data-bs-target="#fulfillModal{{ request.id }}">
                                            ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å
                                        </button>
                                        <form method="post" action="{% url 'delete_restock_request' request.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" 
                                                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?')">
                                                ‚ùå –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </form>
                                    </td>
                                </tr>

                                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ -->
                                <div class="modal fade" id="fulfillModal{{ request.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                            </div>
                                            <form method="post" action="{% url 'fulfill_restock_request' request.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle"></i>
                                                        –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —É–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫—É–ø–∫–∏
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ request.ingredient.name }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                                        <input type="text" class="form-control" 
                                                               value="+{{ request.quantity_change }} {{ request.ingredient.unit }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–¢–µ–∫—É—â–∏–π –∑–∞–ø–∞—Å:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ request.ingredient.stock.current_quantity }} {{ request.ingredient.unit }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—Ä—É–±/{{ request.ingredient.unit }}):</label>
                                                        <input type="number" name="cost_per_unit" class="form-control" 
                                                               step="0.01" min="0" required
                                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 150.50">
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é:</label>
                                                        <textarea name="notes" class="form-control" rows="3" 
                                                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫—É–ø–∫–∞ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞, –¥–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ç.–¥."></textarea>
                                                    </div>
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                        –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                    <button type="submit" class="btn btn-success">–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏ -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">–¢–µ–∫—É—â–∏–µ –∑–∞–ø–∞—Å—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                                    <th>–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π</th>
                                    <th>–ï–¥–∏–Ω–∏—Ü–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in stocks %}
                                <tr class="{% if stock.is_out_of_stock %}table-danger{% elif stock.is_low %}table-warning{% endif %}">
                                    <td>
                                        <strong>{{ stock.ingredient.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="font-weight-bold {% if stock.is_out_of_stock %}text-danger{% elif stock.is_low %}text-warning{% endif %}">
                                            {{ stock.current_quantity }}
                                        </span>
                                    </td>
                                    <td>{{ stock.min_quantity }}</td>
                                    <td>{{ stock.unit }}</td>
                                    <td>
                                        {% if stock.is_out_of_stock %}
                                            <span class="badge bg-danger">–ó–∞–∫–æ–Ω—á–∏–ª—Å—è</span>
                                        {% elif stock.is_low %}
                                            <span class="badge bg-warning">–ú–∞–ª–æ</span>
                                        {% else %}
                                            <span class="badge bg-success">–ù–æ—Ä–º–∞</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-primary" 
                                                    data-bs-toggle="modal" data-bs-target="#restockModal{{ stock.id }}">
                                                ‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                                            </button>
                                            <button type="button" class="btn btn-info" 
                                                    data-bs-toggle="modal" data-bs-target="#adjustModal{{ stock.id }}">
                                                üìù –ò–∑–º–µ–Ω–∏—Ç—å
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
                                <div class="modal fade" id="restockModal{{ stock.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                            </div>
                                            <form method="post" action="{% url 'restock_ingredient' stock.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.ingredient.name }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.current_quantity }} {{ stock.unit }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è ({{ stock.unit }}):</label>
                                                        <input type="number" name="quantity" class="form-control" 
                                                               min="0.01" step="0.01" required
                                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5.00">
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—Ä—É–±/{{ stock.unit }}):</label>
                                                        <input type="number" name="cost_per_unit" class="form-control" 
                                                               step="0.01" min="0" required
                                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 150.50">
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                                                        <textarea name="notes" class="form-control" rows="3" 
                                                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫—É–ø–∫–∞ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ '–ü—Ä–æ–¥—É–∫—Ç—ã+'"></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                    <button type="submit" class="btn btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ -->
                                <div class="modal fade" id="adjustModal{{ stock.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                            </div>
                                            <form method="post" action="{% url 'adjust_stock' stock.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏.
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.ingredient.name }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.current_quantity }} {{ stock.unit }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ({{ stock.unit }}):</label>
                                                        <input type="number" name="new_quantity" class="form-control" 
                                                               value="{{ stock.current_quantity }}" min="0" step="0.01" required>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è:</label>
                                                        <textarea name="notes" class="form-control" rows="3" 
                                                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, —Å–ø–∏—Å–∞–Ω–∏–µ –±—Ä–∞–∫–∞ –∏ —Ç.–¥." required></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–ø–∞—Å–∞—Ö
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –ê–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        const restockModals = document.querySelectorAll('[id^="restockModal"]');
        restockModals.forEach(modal => {
            const quantityInput = modal.querySelector('input[name="quantity"]');
            if (quantityInput) {
                // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø–æ–ª–Ω—è—Ç—å –¥–æ 2x –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞
                const currentQty = parseFloat(modal.querySelector('input[readonly]').value.split(' ')[0]) || 0;
                const recommended = Math.max(10, 20 - currentQty); // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞
                quantityInput.value = recommended.toFixed(2);
            }
        });
    });
</script>
{% endblock %}