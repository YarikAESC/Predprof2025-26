{% extends 'base.html' %}

{% block title %}Создание комбо-набора{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <!-- Заголовок карточки создания комбо-набора -->
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-layer-group"></i> Создание комбо-набора</h4>
        </div>
        <div class="card-body">
            <!-- Информационное сообщение -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Настройте количество каждого блюда и укажите, сколько раз хотите заказать этот набор.
            </div>

            <!-- Таблица с блюдами из корзины -->
            <h5>Состав набора:</h5>
            <table class="table table-sm" id="itemsTable">
                <thead>
                    <tr>
                        <th>Блюдо</th>
                        <th style="width: 150px;">Количество</th>
                        <th>Цена за шт.</th>
                        <th>Сумма</th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <!-- Цикл по всем блюдам из корзины -->
                    {% for item in cart_items %}
                    <tr class="item-row" data-dish-id="{{ item.dish.id }}" data-price="{{ item.dish.price }}">
                        <td>
                            <!-- Название блюда -->
                            {{ item.dish.name }}
                            <!-- Скрытое поле для ID блюда -->
                            <input type="hidden" name="dish_{{ item.dish.id }}" value="{{ item.dish.id }}">
                        </td>
                        <td>
                            <!-- Группа кнопок для изменения количества -->
                            <div class="input-group input-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="changeQuantity(this, -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <!-- Поле ввода количества -->
                                <input type="number" name="quantity_{{ item.dish.id }}"
                                       class="form-control text-center quantity-input"
                                       value="{{ item.quantity }}" min="0" max="99"
                                       data-price="{{ item.dish.price }}"
                                       onchange="updateCalculations()">
                                <button type="button" class="btn btn-outline-secondary" onclick="changeQuantity(this, 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <!-- Цена за единицу блюда -->
                        <td class="unit-price">{{ item.dish.price }} ₽</td>
                        <!-- Общая стоимость этой позиции -->
                        <td class="item-total">{{ item.total }} ₽</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <!-- Строка стоимости одного набора -->
                    <tr class="table-light">
                        <th colspan="3" class="text-end">Стоимость одного набора:</th>
                        <th><span id="singlePrice">{{ single_price }}</span> ₽</th>
                    </tr>
                    <!-- Строка количества повторов -->
                    <tr class="table-warning">
                        <th colspan="3" class="text-end">Количество повторов:</th>
                        <th>× <span id="repeatsDisplay">1</span></th>
                    </tr>
                    <!-- Итоговая строка с общей суммой -->
                    <tr class="table-success">
                        <th colspan="3" class="text-end">Итого к оплате:</th>
                        <th><span id="totalPrice" class="fs-4 text-success">{{ single_price }}</span> ₽</th>
                    </tr>
                </tfoot>
            </table>

            <!-- Блок с информацией о балансе и предупреждением -->
            <div class="alert alert-warning" id="balanceAlert">
                <i class="fas fa-exclamation-triangle"></i>
                С баланса будет списано <strong><span id="displayTotal">{{ single_price }}</span> ₽</strong>.
                Ваш текущий баланс: <strong id="userBalance">{{ user.balance }}</strong> ₽
                <!-- Предупреждение о недостатке средств (скрыто по умолчанию) -->
                <span id="balanceWarning" class="text-danger d-none">
                    <br><i class="fas fa-times-circle"></i> Недостаточно средств!
                </span>
            </div>

            <!-- Основная форма создания комбо-набора -->
            <form method="post" id="comboForm">
                {% csrf_token %}

                <!-- Контейнер для динамически создаваемых скрытых полей -->
                <div id="hiddenFields"></div>

                <!-- Поле для названия набора -->
                <div class="mb-3">
                    <label class="form-label">Название набора *</label>
                    <input type="text" name="name" class="form-control" required
                           placeholder="Например: 'Мой завтрак' или 'Обед на неделю'">
                </div>

                <!-- Поле для описания набора -->
                <div class="mb-3">
                    <label class="form-label">Описание (необязательно)</label>
                    <textarea name="description" class="form-control" rows="2"
                              placeholder="Добавьте описание вашего набора"></textarea>
                </div>

                <!-- Поле для выбора количества повторов -->
                <div class="mb-3">
                    <label class="form-label">Количество повторов *</label>
                    <div class="input-group">
                        <!-- Кнопка уменьшения -->
                        <button type="button" class="btn btn-outline-secondary" onclick="changeRepeats(-1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <!-- Поле ввода количества повторов -->
                        <input type="number" name="max_orders" id="maxOrders" class="form-control text-center"
                               required min="1" max="100" value="1" style="max-width: 100px;">
                        <!-- Кнопка увеличения -->
                        <button type="button" class="btn btn-outline-secondary" onclick="changeRepeats(1)">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="input-group-text">раз</span>
                    </div>
                    <!-- Подсказка к полю -->
                    <div class="form-text">
                        Сколько раз вы сможете заказать этот набор. Каждый заказ = один набор с выбранными блюдами.
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="d-grid gap-2 d-md-flex">
                    <!-- Кнопка отправки формы (сохраняет набор) -->
                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                        <i class="fas fa-check"></i> Оплатить <span id="btnTotal">{{ single_price }}</span> ₽
                    </button>
                    <!-- Кнопка возврата в корзину -->
                    <a href="{% url 'view_cart' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i> Вернуться в корзину
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript для динамических вычислений и управления формой -->
<script>
// Получаем баланс пользователя из шаблона Django
const userBalance = parseFloat('{{ user.balance }}');

// Функция изменения количества блюд кнопками +/-
function changeQuantity(btn, delta) {
    const input = btn.parentElement.querySelector('.quantity-input');
    let current = parseInt(input.value) || 0;
    current += delta;
    // Ограничиваем минимальное и максимальное значение
    if (current < 0) current = 0;
    if (current > 99) current = 99;
    input.value = current;
    updateCalculations();
}

// Функция изменения количества повторов кнопками +/-
function changeRepeats(delta) {
    const input = document.getElementById('maxOrders');
    let current = parseInt(input.value) || 1;
    current += delta;
    // Ограничиваем минимальное и максимальное значение
    if (current < 1) current = 1;
    if (current > 100) current = 100;
    input.value = current;
    updateCalculations();
}

// Основная функция пересчёта всех стоимостей
function updateCalculations() {
    let singlePrice = 0;

    // Считаем стоимость одного набора по всем строкам с блюдами
    document.querySelectorAll('.item-row').forEach(row => {
        const input = row.querySelector('.quantity-input');
        const price = parseFloat(input.dataset.price);
        const quantity = parseInt(input.value) || 0;
        const itemTotal = price * quantity;

        // Обновляем сумму в строке таблицы
        row.querySelector('.item-total').textContent = itemTotal.toFixed(2) + ' ₽';

        singlePrice += itemTotal;
    });

    // Получаем количество повторов из поля ввода
    const repeats = parseInt(document.getElementById('maxOrders').value) || 1;
    const totalPrice = singlePrice * repeats;

    // Обновляем все элементы отображения на странице
    document.getElementById('singlePrice').textContent = singlePrice.toFixed(2);
    document.getElementById('repeatsDisplay').textContent = repeats;
    document.getElementById('totalPrice').textContent = totalPrice.toFixed(2);
    document.getElementById('displayTotal').textContent = totalPrice.toFixed(2);
    document.getElementById('btnTotal').textContent = totalPrice.toFixed(2);

    // Проверяем достаточность баланса пользователя
    const balanceWarning = document.getElementById('balanceWarning');
    const submitBtn = document.getElementById('submitBtn');

    if (totalPrice > userBalance) {
        // Показываем предупреждение и блокируем кнопку отправки
        balanceWarning.classList.remove('d-none');
        submitBtn.disabled = true;
        submitBtn.classList.add('btn-danger');
        submitBtn.classList.remove('btn-success');
    } else {
        // Скрываем предупреждение и активируем кнопку
        balanceWarning.classList.add('d-none');
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-danger');
        submitBtn.classList.add('btn-success');
    }

    // Обновляем скрытые поля для отправки данных формы
    updateHiddenFields();
}

// Функция обновления скрытых полей формы
function updateHiddenFields() {
    const container = document.getElementById('hiddenFields');
    container.innerHTML = '';

    // Для каждого блюда с ненулевым количеством создаём скрытые поля
    document.querySelectorAll('.item-row').forEach(row => {
        const dishId = row.dataset.dishId;
        const quantity = row.querySelector('.quantity-input').value;

        // Создаём поля только если количество больше 0
        if (parseInt(quantity) > 0) {
            // Скрытое поле для ID блюда
            const inputDish = document.createElement('input');
            inputDish.type = 'hidden';
            inputDish.name = 'dish_' + dishId;
            inputDish.value = dishId;
            container.appendChild(inputDish);

            // Скрытое поле для количества
            const inputQty = document.createElement('input');
            inputQty.type = 'hidden';
            inputQty.name = 'quantity_' + dishId;
            inputQty.value = quantity;
            container.appendChild(inputQty);
        }
    });
}

// Добавляем обработчики событий для поля количества повторов
document.getElementById('maxOrders').addEventListener('input', updateCalculations);
document.getElementById('maxOrders').addEventListener('change', updateCalculations);

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Первоначальный расчёт
    updateCalculations();

    // Добавляем обработчики на все поля ввода количества
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('input', updateCalculations);
        input.addEventListener('change', updateCalculations);
    });
});
</script>
{% endblock %}