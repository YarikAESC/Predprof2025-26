{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞–ø–∞—Å—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ - –ü–æ–≤–∞—Ä{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>üì¶ –ó–∞–ø–∞—Å—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h2>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center py-3">
                            <h5>–í—Å–µ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h5>
                            <h3>{{ total_stocks }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center py-3">
                            <h5>–ú–∞–ª–æ –æ—Å—Ç–∞–ª–æ—Å—å</h5>
                            <h3>{{ low_stock_count }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center py-3">
                            <h5>–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</h5>
                            <h3>{{ out_of_stock_count }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'chef_prepare_dishes' %}" class="btn btn-success btn-block h-100 d-flex flex-column justify-content-center">
                        <i class="fas fa-utensils fa-2x mb-2"></i>
                        <span>–ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –±–ª—é–¥–∞</span>
                    </a>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–∞—Å–æ–≤ -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                                    <th>–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å</th>
                                    <th>–ï–¥–∏–Ω–∏—Ü–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in stocks %}
                                <tr class="{% if stock.is_out_of_stock %}table-danger{% elif stock.is_low %}table-warning{% endif %}">
                                    <td>
                                        <strong>{{ stock.ingredient.name }}</strong>
                                        {% if stock.ingredient.stock_history.exists %}
                                        <br>
                                        <small class="text-muted">
                                            –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: {{ stock.last_restocked|date:"d.m.Y" }}
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="font-weight-bold {% if stock.is_out_of_stock %}text-danger{% elif stock.is_low %}text-warning{% endif %}">
                                            {{ stock.current_quantity }}
                                        </span>
                                    </td>
                                    <td>{{ stock.min_quantity }}</td>
                                    <td>{{ stock.unit }}</td>
                                    <td>
                                        {% if stock.is_out_of_stock %}
                                            <span class="badge bg-danger">–ó–∞–∫–æ–Ω—á–∏–ª—Å—è</span>
                                            <br><small class="text-danger">–°—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å!</small>
                                        {% elif stock.is_low %}
                                            <span class="badge bg-warning">–ú–∞–ª–æ</span>
                                            <br><small class="text-warning">–û—Å—Ç–∞–ª–æ—Å—å: {{ stock.current_quantity|floatformat:1 }}</small>
                                        {% else %}
                                            <span class="badge bg-success">–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ</span>
                                            <br><small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å: {{ stock.current_quantity|floatformat:1 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-info" 
                                                data-bs-toggle="modal" data-bs-target="#requestModal{{ stock.id }}">
                                            <i class="fas fa-envelope"></i> –ó–∞–ø—Ä–æ—Å–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>

                                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ -->
                                <div class="modal fade" id="requestModal{{ stock.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                            </div>
                                            <form method="post" action="{% url 'request_restock' stock.ingredient.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle"></i>
                                                        –ó–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø–∞—Å–æ–≤.
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.ingredient.name }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.current_quantity }} {{ stock.unit }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ stock.min_quantity }} {{ stock.unit }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∑–∞–∫–∞–∑–∞ ({{ stock.unit }}):</label>
                                                        <input type="number" name="quantity" class="form-control" 
                                                               min="1" step="0.01" required 
                                                               placeholder="–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: {{ stock.min_quantity|add:10 }}">
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                                                        <textarea name="notes" class="form-control" rows="3" 
                                                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–µ–Ω —Å—Ä–æ—á–Ω–æ, –¥–ª—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –±–ª—é–¥ –∏ —Ç.–¥."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–ø–∞—Å–∞—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.
                                            <br>
                                            <small class="text-muted">
                                                –í–æ–∑–º–æ–∂–Ω–æ, –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É.
                                            </small>
                                        </div>
                                        <a href="{% url 'manage_dishes' %}" class="btn btn-outline-primary mt-2">
                                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            const quantityInput = modal.querySelector('input[name="quantity"]');
            if (quantityInput && quantityInput.placeholder.includes('–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:')) {
                const recommended = quantityInput.placeholder.match(/(\d+\.?\d*)/);
                if (recommended) {
                    quantityInput.value = recommended[0];
                }
            }
        });
    });
</script>
{% endblock %}