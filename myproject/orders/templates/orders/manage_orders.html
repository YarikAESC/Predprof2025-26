{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center py-3">
                            <h5>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</h5>
                            <h3>{{ total_orders }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center py-3">
                            <h5>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</h5>
                            <h3>{{ active_orders }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center py-3">
                            <h5>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</h5>
                            <h3>{{ completed_orders }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center py-3">
                            <h5>–û—Ç–º–µ–Ω–µ–Ω–æ</h5>
                            <h3>{{ cancelled_orders }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤ -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–£—á–µ–Ω–∏–∫</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ë–ª—é–¥–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr class="{% if order.status == 'cancelled' %}table-danger{% elif order.status == 'ready' %}table-success{% elif order.status == 'preparing' %}table-warning{% endif %}">
                                    <td>
                                        <strong>#{{ order.id }}</strong>
                                    </td>
                                    <td>
                                        {{ order.customer.get_full_name|default:order.customer.username }}
                                        <br>
                                        <small class="text-muted">{{ order.customer.email|default:"–ë–µ–∑ email" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if order.status == 'pending' %}bg-secondary
                                            {% elif order.status == 'preparing' %}bg-warning
                                            {% elif order.status == 'ready' %}bg-success
                                            {% elif order.status == 'picked_up' %}bg-info
                                            {% elif order.status == 'delivered' %}bg-primary
                                            {% elif order.status == 'cancelled' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ order.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ order.total_price }} ‚ÇΩ</strong>
                                    </td>
                                    <td>
                                        {{ order.created_at|date:"d.m.Y H:i" }}
                                        <br>
                                        <small class="text-muted">{{ order.created_at|timesince }} –Ω–∞–∑–∞–¥</small>
                                    </td>
                                    <td>
                                        <small>
                                            {% for item in order.items.all|slice:":2" %}
                                                {{ item.dish.name }} x{{ item.quantity }}<br>
                                            {% endfor %}
                                            {% if order.items.count > 2 %}
                                                <em>–∏ –µ—â–µ {{ order.items.count|add:"-2" }}...</em>
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'order_detail' order.id %}" 
                                               class="btn btn-info" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-primary" 
                                                    data-bs-toggle="modal" data-bs-target="#statusModal{{ order.id }}"
                                                    title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if order.status == 'pending' %}
                                            <form method="post" action="{% url 'mark_paid' order.id %}" 
                                                  class="d-inline" onsubmit="return confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π?')">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success" title="–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>

                                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
                                <div class="modal fade" id="statusModal{{ order.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ #{{ order.id }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                            </div>
                                            <form method="post" action="{% url 'update_order_status' order.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ order.get_status_display }}" readonly>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                                                        <select name="status" class="form-select" required>
                                                            {% for status_code, status_name in status_choices %}
                                                            <option value="{{ status_code }}" 
                                                                    {% if order.status == status_code %}selected{% endif %}>
                                                                {{ status_name }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                                                        <textarea name="notes" class="form-control" rows="3" 
                                                                  placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                    {% if orders.has_other_pages %}
                    <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if orders.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ orders.previous_page_number }}">
                                    &laquo;
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&laquo;</span>
                            </li>
                            {% endif %}
                            
                            {% for i in orders.paginator.page_range %}
                                {% if orders.number == i %}
                                <li class="page-item active">
                                    <span class="page-link">{{ i }}</span>
                                </li>
                                {% elif i > orders.number|add:'-3' and i < orders.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if orders.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ orders.next_page_number }}">
                                    &raquo;
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&raquo;</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
    function confirmAction(message) {
        return confirm(message || "–í—ã —É–≤–µ—Ä–µ–Ω—ã?");
    }
</script>
{% endblock %}