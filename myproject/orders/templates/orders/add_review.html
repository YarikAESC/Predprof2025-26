{% extends 'base.html' %}

{% block content %}
<div class="container">
    <!-- Заголовок страницы с названием блюда -->
    <h2>Оставить отзыв на {{ dish.name }}</h2>
    <!-- Информация о заказе -->
    <p>Заказ #{{ order.id }} от {{ order.created_at|date:"d.m.Y" }}</p>
    
    <!-- Проверка системных сообщений -->
    {% if messages %}
        {% for message in messages %}
            <!-- Если сообщение содержит слово "отзыв" -->
            {% if 'отзыв' in message|lower %}
                <div class="alert alert-warning">
                    {{ message }}
                </div>
                <!-- Кнопка возврата к истории заказов -->
                <a href="{% url 'order_history' %}" class="btn btn-primary">Вернуться к истории заказов</a>
            {% endif %}
        {% endfor %}
    {% else %}
        <!-- Форма для отправки отзыва -->
        <form method="post" id="reviewForm" onsubmit="return checkReview()">
            {% csrf_token %}
            
            <!-- Поле для выбора оценки -->
            <div class="mb-3">
                <label for="rating" class="form-label">Оценка (1-5):</label>
                <select class="form-control" id="rating" name="rating" required>
                    <option value="">Выберите оценку</option>
                    <option value="5">5 - Отлично</option>
                    <option value="4">4 - Хорошо</option>
                    <option value="3">3 - Нормально</option>
                    <option value="2">2 - Плохо</option>
                    <option value="1">1 - Ужасно</option>
                </select>
            </div>
            
            <!-- Поле для комментария -->
            <div class="mb-3">
                <label for="comment" class="form-label">Комментарий:</label>
                <textarea class="form-control" id="comment" name="comment" rows="4"></textarea>
            </div>
            
            <!-- Кнопки отправки формы и отмены -->
            <button type="submit" class="btn btn-primary">Отправить отзыв</button>
            <a href="{% url 'order_history' %}" class="btn btn-secondary">Назад</a>
        </form>
    {% endif %}
</div>

<!-- JavaScript для обработки отправки формы -->
<script>
// Флаг для предотвращения двойной отправки формы
let formSubmitted = false;

// Функция проверки перед отправкой отзыва
function checkReview() {
    // Проверяем, не была ли форма уже отправлена
    if (formSubmitted) {
        alert('Вы уже отправили отзыв. Пожалуйста, не нажимайте кнопку несколько раз.');
        return false;
    }
    // Устанавливаем флаг отправки
    formSubmitted = true;
    
    // Меняем текст и состояние кнопки отправки
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
    submitBtn.disabled = true;
    
    // Разрешаем отправку формы
    return true;
}

// Обработчик для предотвращения повторной отправки при возврате на страницу
window.addEventListener('pageshow', function(event) {
    // Проверяем, была ли страница восстановлена из кэша
    if (event.persisted || performance.getEntriesByType('navigation')[0].type === 'back_forward') {
        // Перезагружаем страницу, чтобы сбросить состояние формы
        location.reload();
    }
});
</script>
{% endblock %}